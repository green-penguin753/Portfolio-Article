# 【Security】CSRF(クロスサイト・リクエスト・フォージェリ)＋ Laravel 実装

# 概要

Web アプリケーションのセッション管理に脆弱性があり、  
ユーザーが<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">ログインした状態</span>で攻撃者の罠リンクを踏むことで、  
ユーザーの<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">知らないうちに攻撃者がユーザーになりすまし</span>て、不正な操作を実行する攻撃手法。

- Cookie によるセッション管理、Basic 認証、SSL クライアント認証を実装しているサイトは特に注意する。  
  ネットバンキング、会員専用サイトなど金銭処理やログイン機能を持つもの。

###### 発生しうる脅威

- 個人情報の漏洩  
  ユーザーの権限範囲内の情報しか閲覧できないが、  
  パスワード変更などが成功した場合は、その後なりすまし攻撃につながる。

- <span style="background: linear-gradient(transparent 40%, #F9C1CF 100%);">金銭的被害</span>  
  不正送金やクレジットカードの不正利用、EC サイトで意図しない商品購入など

- 登録情報の漏洩・改ざん  
  各種設定の変更や退会処理、掲示板への不適切な書き込みなど

# 原因

Web アプリケーションが、  
本来は拒否すべき他サイトからのリクエストを受信し処理してしまうこと。

# 対策

ログイン中のユーザーができる操作に対して対策をする。

### 根本的解決

###### １.<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">CSRF トークンを発行する

- リクエストが本当にユーザー本人の意思によるものかどうか確認する。
- ユーザーの入力内容を確認する画面で、サーバーから CSRF トークンを発行し hidden パラメータに出力する。  
  フォーム送信するときに hidden パラメータのトークンとサーバーに保持している CSRF トークンを比較し、一致しないときは処理を中止する。
- フォーム送信は POST メソッドでする。

###### ２.処理の直前に再度パスワードを入力させる

- 重要な操作の直前のページでユーザーに再度パスワードを入力させ、
  そのパスワードが正しい場合のみ処理をする。
- CSRF トークンより実装が簡単でコストも下がるが、画面設計の仕様変更が必要となる。

###### ３.Referer をチェックする

- Referer でそのリクエストが正しいサイトからか罠サイトからなのかを判別することができ、
  正しいページの URL からのときのみ処理を実行する。

- ユーザーが Referer を送信しない設定(ブラウザやファイアーウォール)にしているときは、
  サイトを利用できないなど不都合が起きるので注意する。

### 保険的対策

###### ４.登録済みのメールアドレスに自動送信する

- CSRF 攻撃自体は防げないが、攻撃されたときに利用者が異変に気づくきっかけになる。
- メール本文にはプライバシーに関わる重要な情報は書かない。

# Laravel での実装例

### 1.<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">フォームに@csrf</span>と書いてトークンを発行する

ビューの blade.php ファイルに

```php
<form method="post" action="{{ route('ルーティング先') }}">
	@csrf
	処理内容
</form>
```

☀︎「@csrf」と書くだけで CSRF トークンが生成され、フォームへ埋め込まれトークンの検証までしてくれる。

### 2.デフォルトでミドルウェア機能が搭載

Laravel では「VerifyCsrfToken」ミドルウェアがデフォルトで有効なので、  
「@csrf」と書くだけで追加の作業は不要。

---

### 参考にしたサイト

- 安全な Web サイトの作り方 改定第 7 版
- https://qiita.com/wanko5296/items/142b5b82485b0196a2da
- https://zenn.dev/sonicmoov/articles/ed58467919eec5
- https://www.aeyescan.jp/blog/cross-site_request_forgeries/#toc2
