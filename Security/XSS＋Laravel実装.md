# 【Security】クロスサイト・スクリプティング(XSS)＋ Laravel 実装

# 概要

Web アプリケーションの出力処理に脆弱性があると、  
攻撃者に<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">HTML 内に悪意のあるスクリプトを埋め込まれる</span>。  
ユーザーのブラウザ上でスクリプトを実行させ、
出力されたその情報を盗み取る（攻撃者のサーバーに送信させるなど）攻撃。

- Cookie を使ってログインのセッション管理をしているサイトは特に注意する。

###### ユーザーにスクリプトを送信させる方法

- 反射型：悪意のあるメール等の URL をユーザーがクリックしたとき
- 格納型：掲示板などでスクリプト付きの投稿をユーザーにさせて、他のユーザーが閲覧したとき
- DOM 型：javascript の脆弱性を狙う

<br>

###### 発生しうる脅威

- <span style="background: linear-gradient(transparent 40%, #F9C1CF 100%);">フィッシング詐欺による重要情報の漏洩</span>  
  本物の Web サイト上に偽のフォームが表示され、ユーザーが入力した個人情報が盗まれる。

- Cookie 情報の漏洩  
  Cookie に格納されていた個人情報やセッション ID が盗まれ、
  セッションハイジャックによるなりすまし、不正アクセスにつながる。

- ブラウザに任意の Cookie を保存させられる  
  攻撃者がユーザーのブラウザにある Cookie を、Set-Cookie ヘッダを使って書き換える。  
  セッション ID の固定化攻撃につながる。

- 偽情報の流布による混乱

# 原因

- 出力前のエスケープ処理の未実施や抜けもれ
- 文字コードの未指定
- 入力値のバリデーションの不足

# 対策

### 根本的解決

###### １.<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">すべての出力要素にエスケープ処理</span>をする

- 特別な意味を持つ文字を HTML エンティティへ変換し、無害化(サニタイジング)する。
- HTML タグを出力するときは、属性値を必ずダブルクォートでくくる。
- すべての出力に対して処理を行うが、ユーザーからの入力、データベースやファイルから読み込んだ文字列、演算によって生成した文字列等に特に注意する。

```php
$keyword = param('keyword'):

print "<input  value="$keyword">”
↓
print "<input  value=\"" . htmlspecialchars($keyword, ENT_QUOTES). "\">";
```

☀︎PHP の htmlspecialchars()は、  
スクリプトの構成に必要な特殊文字（&，<，>，”，’）を、(&amp:, &lt;, &gt;, &quot; &#39;)へ置換する関数。
「ENT_QUOTES」と指定すると、"と'の両方がエスケープされる。

###### ２.「http://」「https://」で始まる URL のみ許可する

- href, rel, src などの属性値にユーザからの入力を使うとき、「javascript:」から始まるスクリプトを埋め込まれてしまう。

###### ３.文字コードの指定する

- ブラウザは受け取った HTML を指定した文字コードで解釈する。

① HTTP レスポンスヘッダの「Content-Type」フィールドに、「charaset=UTF-8」と指定する  
② HTML の META 宣言に、「charaset=UTF-8」と指定する  
③ 設定など外部リソースを指しているファイルにも文字コードを指定する

### 保険的対策

###### ４.Cookie の発行時に HttpOnly 属性をつける

- Cookie 情報の漏洩対策の一つで、盗用を防ぐ。
- HTML テキスト内のスクリプトからアクセスできなくなる。
- 発行するときに「Set-Cookie: HttpOnly」と設定する。

###### ５.ユーザーからの入力値を制限する

- XSS 攻撃ではリンク等を踏ませるため、入力側のバリデーションを経由することはないが、  
  入力値のバリデーションで不正な入力を排除することができ、  
  攻撃のリスクを減らすことはできる。

- ホワイトリスト方式を使う  
  その引数に許可する文字の組み合わせを決めておき、それ以外は許可しない方式。
  郵便番号の入力なら、数字以外の入力を許可しない。
  他にも入力値の長さ制限をつけることで、攻撃が可能となるスクリプトの挿入を抑制することもできる。

- 出力の文字列は削除ではなく、無害化(サニタイジング)で置換するようにする。
  削除したことにより、スクリプト文字列を形成してしまう。

# Laravel での実装例

### 1.　{{ }}で囲みエスケープ処理をする

- <span style="background: linear-gradient(transparent 60%, #ffff00 60%);">出力する変数を{{ $変数名 }}と囲む</span>だけで、自動的に PHP の htmlspecialchars 関数を通されエスケープ処理をしてくれる。

- エスケープ処理をしたくないときは、{!! $変数名 !!}と囲む。非推奨

ビューの blade.php ファイルに

```php
<body class="antialiased">
	@auth
		<p>
			{{ Auth::user()->name }}さん、こんにちは。
		</p>
	@endauth
</body>
```

☀︎ ログイン中のユーザーの名前を表示している。

- @auth ディレクティブで、ログイン済みユーザーだけに表示している。

---

### 参考にしたサイト

- 安全なウェブサイトの作り方　改定第 7 版
- https://qiita.com/Paragonn/items/1dd6663d6bb819b616e9
- https://service.shiftinc.jp/column/9465/
- https://www.shadan-kun.com/waf_websecurity/xss/
