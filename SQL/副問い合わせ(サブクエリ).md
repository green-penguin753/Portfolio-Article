# 【SQL】副問い合わせ(サブクエリ)

# 副問い合わせとは

副問い合わせとは、  
<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">SQL 文の内部に別の SELECT 文を記述</span>すること。

- 1 つの SQL 文で 2 つ以上の処理ができ、DBMS に対して柔軟な指示ができる仕組み。
- 副問い合わせは、<span style="background: linear-gradient(transparent 40%, #F9C1CF 100%);">()で括って記述</span>する。
  <br>

- WHERE・SELECT・FROM・HAVING 句、INSERT/UPDATE/DELETE 文などさまざまな場所で使える。

- <span style="background: linear-gradient(transparent 40%, #F9C1CF 100%);">内側の SELECT 文(副問い合わせ)」が先に実行</span>され、  
  その結果を使って「外側の SQL 文(主問い合わせ)」が実行される。

- 副問い合わせの中でさらに副問い合わせを使える(ネスト)が、SQL が複雑になりやすい。

# 副問い合わせの種類

内側の SELECT 文の結果の構造や依存関係によって、3 つに分けられる。

#### 1.単一行副問い合わせ(スカラーサブクエリ)

- <span style="background: linear-gradient(transparent 60%, #ffff00 60%);">「1 つの値（1 行 1 列）」</span>だけを返す。
- 比較演算子で直接比較ができる。

```SQL
SELECT  *
 FROM  orders
 WHERE  price = (SELECT MAX(price)
           FROM   orders
           );
```

☀︎orders テーブルの最も高い価格のすべての列を取得できる。

#### 2.複数行副問い合わせ

- <span style="background: linear-gradient(transparent 60%, #ffff00 60%);">「複数の値（複数行１列）」</span>を返す。
- 比較演算子だけではエラーとなるため、  
  IN/NOT IN、ANY/ALL 演算子や EXISTS / NOT EXISTS を使う。

###### IN / NOT IN(条件に当てはまるものを抽出)

```
SELECT *
FROM customers
WHERE id IN (SELECT customer_id
        FROM orders
        WHERE price >= 5000
        );
```

☀︎5,000 円以上の注文履歴がある顧客の情報一覧を取得できる。

- `NOT IN`では「5,000 円以上の注文履歴がない顧客」と否定形となる。

#### 3.相関副問い合わせ

- <span style="background: linear-gradient(transparent 60%, #ffff00 60%);">外側のテーブルの値を１行ずつ副問い合わせに渡して実行し判定する</span>。  
  そのため、各行ごとに異なる結果となり条件に当てはまった行のみ返す

###### EXISTS(存在のチェック)

- 外側のテーブルの各行ごとに副問い合わせを実行し、TRUE か FALSE の判断を繰り返す。
- そのデータが副問い合わせの中に存在すると「真」、存在しないと「偽」となる。
- `NOT EXESTS`は真と偽が反対になる。

```SQL
SELECT *
FROM customers
WHERE EXISTS (
         SELECT customer_id
         FROM orders
         WHERE orders.customer_id = customers.id
         );
```

☀︎orders テーブルに注文履歴がある顧客の情報一覧を取得できる

# 副問い合わせと JOIN 句の使い分け

複数行副問い合わせの「5,000 円以上の注文履歴がある顧客の情報一覧」を、  
JOIN を使って書くこともできる。

```SQL
SELECT DISTINCT customers.*
FROM customers
JOIN orders ON orders.customer_id  = customers.id
WHERE orders.price >= 5000;
```

- 副問い合わせは

  - 条件付きの絞り込みや複雑な条件・集計結果に使うと便利。
  - FROM 句で使うと、一時的なテーブルのように扱える。
  - 大量データのときは処理が遅くなりやすい。

- JOIN 句は
  - 複数テーブルのカラムを同時に取得するときや、関連データをまとめて処理したいときに使う。
  - 複数のテーブルを組み合わせた集計や分析に便利
  - インデックスが貼られている場合、大量データでも高速に処理ができる。

---

### 参考にしたサイト

- https://saycon.co.jp/portal-for-newcomer/mysql/%E5%89%AF%E5%95%8F%E5%90%88%E3%81%9B
- https://route-zero.com/recruit/route/989/
