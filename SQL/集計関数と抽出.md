# 【SQL】集計関数と抽出

集計関数とは、  
グループ化された データや複数行(レコード)のデータに対して処理をかけて 1 つの値にまとめる関数のこと。

- データの分析に活用できる。

- NULL 値は基本的に含めずに集計される。

- 集計関数を記述できる箇所は、
  - SELECT 文の選択列リスト
  - ORDER BY 句
  - HAVING
  - (WHERE 句では使えない。)

# 主な集計関数

#### SUM 関数

指定されたカラムの合計を求める。

`SUM(カラム名)`

#### AVG 関数

指定されたカラムの平均値を求める。
`AVG(カラム名)`

#### MAX 関数

指定されたカラムの最大値を求める。

`MAX(カラム名)`

#### MIN 関数

指定されたカラムの最小値を求める。

`MIN(カラム名)`

```SQL
SELECT
  SUM(price),
  AVG(price),
  MAX(price),
  MIN(price)
FROM
  orders;
```

#### COUNT 関数

検索結果の指定したカラムの行数を求める。

`COUNT(カラム名)`

```SQL
SELECT COUNT(price)
FROM  orders;
```

- 指定した行の NULL でない行数を数える。
- `COUNT(*)`アスタリスクを指定したときは、NULL も含めた全ての行数を数える。
- `COUNT(DISTINCT カラム名)` DISTINCT 句と組み合わせて使うと、重複を除いた数を数えられる。

# グループごとの集計

- **SELECT 文の記述順**

```sql
SELECT 列名1, 列名2, ・・・<br>
 FROM テーブル名<br>
 [WHERE 条件式］<br>
 [GROUP BY グループ化列名］<br>
 [HAVING 集計結果に対する条件式］<br>
 [ORDER BY グループ化列名 並び順］
```

#### GROUP BY 句

指定した列でグループ化してグループごとに集計処理をする。

```SQL
SELECT   purchase_date, SUM(price)
FROM     orders
GROUP BY  purchase_date;
```

☀︎ 購入日ごとの合計金額が表示される。

- GROUP BY に複数の列をカンマ区切りで指定すると、  
  その組み合わせごとにグループ化される。  
  「購入日ごと」&「名前ごと」の合計金額も表示できる。

#### HAVING 句

グループ化したデータから条件を絞り込む。

```SQL
SELECT   purchase_date, SUM(price)
FROM     orders
GROUP BY  purchase_date
HAVING SUM(price) > 0;
```

☀︎ 購入日ごとの合計金額から、0 より大きいグループのみ表示される。

- 集計関数は実行順序から WHERE 句では使えないので、HAVING 句で指定する。

---

### 参考にしたサイト

- https://products.sint.co.jp/siob/blog/sql-bootcamp-03
