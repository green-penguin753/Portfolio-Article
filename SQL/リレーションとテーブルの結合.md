# 【SQL】リレーションとテーブルの結合

### リレーショナルデータベース(RDB)とは

データベース構造の一種で、<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">複数の表形式</span>でデータを管理しているもの。

- テーブルを分割していることでデータの管理が効率的になり、安全、確実、高速に処理しやすい。
- ACID 特性を持ち、トランザクション処理の信頼性と安全性が高い。
- 複数のテーブルに分かれるため結合処理が必要になり、わかりづらくなる。
- データ量が多くなると更新するときに時間がかかりやすい。

### リレーションとは

<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">テーブルそのもの</span>。  
 テーブルの列(カラム)の定義とすべての行(レコード)の集まりのこと。

**リレーションシップ**とは、  
テーブル同士を共通した行(カラム)で関連づけること。  
データの整合性をデータベースに保証させることができる。

# Primary Key(主キー)

<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">テーブルの各行(レコード)を重複せずに識別できるようになる列(カラム)</span>のこと。

- Primary Key は、候補キーの中からテーブルごとに 1 つだけ選ばれる。

- 同一の値は存在しないこと(一意性制約)、
  値が NULL でないこと(非 NULL 制約)という制約を必ず満たすもの。

- 社員番号のような自然に一意性を持つ列を「自然キー」という。
- 管理目的で追加された列を「人工キー」という。
- 複数の列を組み合わせることで一意性を確保し、1 つの主キーとしているものを「複合主キー」という。

# Foreign Key(外部キー)

<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">他のテーブルの主キーと関連づけさせるための列(カラム)</span>のこと。

- Foreign Key が指し示す先にあるべき行が存在することによってリレーションシップが成立する。
- 参照先に必ず存在する状態を参照整合性といい、参照制約を満たすもの。
- 制約を満たしている場合は、同じカラムに Primary Key と Foreign Key 両方を付与することもできる。

# JOIN 句

複数の<span style="background: linear-gradient(transparent 60%, #ffff00 60%);">テーブルを結合</span>させる

<div style="background: #f5f5f5;  border-radius: 5px; padding: 10px; margin: 10px;">
<p style="margin: 0;">
SELECT 列名1, 列名2, ・・・<br>
FROM テーブルA<br>
JOIN テーブルB<br>
ON テーブル名.カラム名 = テーブル名.カラム名<br>
</p>
</div>

```SQL
SELECT *
FROM customers
JOIN orders
ON customers.id = orders.customer_id
JOIN items
ON orders.item_id = items.id
```

- 3 つ以上のテーブルの結合は、JOIN・ON 句を追加し 1 つずつ結合処理していく。

- Foreign Key の値が NULL のときは、結合先が見つからず行ごと消滅してしまう。

##### 外部結合

- **内部結合**・・・結合する先が見つからないときは、結果に表示されず行ごと消滅する JOIN 句での結合。
- **外部結合**・・・結合する先が見つからないとき、結合先のカラムに NULL を入れて、すべての行を強制的に表示する方法。

<div style="height: 12px;"><span style="margin-left: 8px; padding: 6px 10px; background:#FBB161 ; color: #ffffff; font-weight: bold; border-radius: 5px;">
外部結合の種類</span></div>
<div style="border: 2px solid#FBB161 ; padding: 25px 12px 10px; font-size: 1em; border-radius: 5px;">
<div style="background: #f5f5f5;  border-radius: 5px; padding: 10px; margin: 10px;">
<p style="margin: 0;">
SELECT 列名1, 列名2, ・・・<br>
FROM テーブルA<br>
LEFT JOIN テーブルB<br>
ON テーブル名.カラム名 = テーブル名.カラム名<br>
</p>
</div>
・<b>左外部結合</b>(LEFT JOIN)<br>
  左のテーブルのすべての行を表示する。<br>
・<b>右外部結合</b>(RIGHT JOIN)<br>
  右のテーブルのすべての行を表示する。<br>
・<b>完全外部結合</b>(FULL JOIN)<br>
  左右のテーブルのすべての行を表示する。<br>
  MySQLはサポート外なのでUNIONで左右をつないで代用する。<br>
</div>

- **自己結合**・・・同じテーブル同士を別名(AS 句)をつけて結合。
- **副問い合わせの結果との結合**・・・テーブルの代わりに副問い合わせの式を入れる。必ず別名(AS 句)をつける。

```SQL
SELECT *
FROM customers
JOIN (
   SELECT * FROM orders
   WHERE price >=5000
   ) AS orders_5000
ON customers.id = orders_5000.customer_id;
```

---

### 参考にしたサイト

- https://products.sint.co.jp/ober/blog/relationship.
- https://x-tech.pasona.co.jp/media/detail.html?p=9391.
- https://qiita.com/masatom86650860/items/ab41a8bbbc2fd59d3ba4
